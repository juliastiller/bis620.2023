---
title: "Extended Abstract: Analysis of Panitumumab Randomized Trial"
author: "Anmol Seth, Julia Stiller"
date: "2023-12-19"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Spectral Signatures}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Background and Motivation

#### Introduction

The Panitumumab Randomized trial In combination with chemotherapy for Metastatic colorectal cancer to determine Efficacy (PRIME) is a pivotal study in the field of oncology. Conducted by Douillard et al. in 2014, the study focused on evaluating the efficacy of panitumumab-FOLFOX4 compared to FOLFOX4 alone as first-line treatment for wild-type (WT) KRAS metastatic colorectal cancer (mCRC).

#### Significance of the PRIME Study

The PRIME study demonstrated that panitumumab-FOLFOX4 significantly improved progression-free survival (PFS) compared to FOLFOX4 in patients with WT KRAS mCRC. This improvement in PFS, along with other key findings, suggests the potential of panitumumab as an effective treatment option for a specific subset of mCRC patients.

#### Context within Scientific Research

Colorectal cancer remains a significant global health concern, and advancements in treatment strategies are crucial for improving patient outcomes. The PRIME study contributes valuable insights into the effectiveness of targeted therapies, emphasizing the importance of molecular profiling, such as KRAS testing, in treatment decision-making.

#### Implications for Healthcare

The positive benefit-risk profile observed in the PRIME study raises important considerations for healthcare practitioners. Understanding the impact of panitumumab-FOLFOX4 on both progression-free survival and overall survival in WT KRAS mCRC patients is vital for informed clinical decision-making.

#### Research Gap Addressed

The study addresses a notable research gap by providing evidence for the efficacy and safety of panitumumab-FOLFOX4 in previously untreated WT KRAS mCRC patients. This information is critical for identifying patients who would benefit the most from this treatment regimen.

#### Motivation for Analysis

Given the significance of the PRIME study, our analysis aims to further explore and validate the findings. We seek to leverage statistical methods to gain a deeper understanding of the impact of panitumumab-FOLFOX4 on key clinical outcomes, thereby contributing to the broader knowledge base in oncology.

# Research Question and Statistical Experiment

## Research Questions

**"Does the presence of KRAS mutations significantly impact the survival outcomes of metastatic colorectal cancer patients receiving different treatment regimens, specifically Panitumumab in combination with FOLFOX and FOLFOX alone?"**

#### Statistical Experiment

1. **Null Hypothesis (H0):** There is no significant difference in survival outcomes between patients with the "Mutant" and "Wild-type" KRAS genotypes, regardless of the treatment arm.

2. **Alternative Hypothesis (H1):** There is a significant difference in survival outcomes between patients with the "Mutant" and "Wild-type" KRAS genotypes, and this difference is influenced by the treatment arm (Panitumumab + FOLFOX vs. FOLFOX alone).

3. **Variables:**
   - **Dependent Variable:** Time to death (Survival Time)
   - **Independent Variable 1:** KRAS Genotype (Categorical: Mutant, Wild-type)
   - **Independent Variable 2:** Treatment Arm (Categorical: Panitumumab + FOLFOX, FOLFOX alone)

4. **Statistical Tests:**
   - **Kaplan-Meier Survival Analysis:** To visualize and compare the survival curves for different genotypes and treatment arms.
   - **Cox Proportional Hazards Model:** To quantify the hazard ratios and assess the impact of genotype and treatment on survival.

5. **Significance Level (α):** Set a predetermined significance level (e.g., α = 0.05) to determine statistical significance.

**Does the combination of Genotype and Treatment Arm have a significant impact on patient survival outcomes?**
Null Hypothesis (H0): The combination of Genotype and Treatment Arm does not significantly impact patient survival outcomes.
Alternative Hypothesis (H1): The combination of Genotype and Treatment Arm significantly impacts patient survival outcomes.

**Are there differences in the occurrence of adverse events between patients receiving Panitumumab in combination with FOLFOX and those receiving FOLFOX alone?**
Null Hypothesis (H0): There is no significant difference in the occurrence of adverse events between treatment arms.
Alternative Hypothesis (H1): There is a significant difference in the occurrence of adverse events between treatment arms.

**Are there significant differences in the survival distribution over time between different genotypes?**
Null Hypothesis (H0): There is no significant difference in the survival distribution over time among different genotypes.
Alternative Hypothesis (H1): There are significant differences in the survival distribution over time among different genotypes.

**Does the treatment arm influence the survival distribution over time within each genotype?**
Null Hypothesis (H0): The treatment arm does not significantly influence the survival distribution over time within each genotype.
Alternative Hypothesis (H1): The treatment arm significantly influences the survival distribution over time within each genotype.

# Data Cleaning and Exploration

## Prepare Environment and Dataset

```{r Setup, message=FALSE, warning=FALSE}
library(haven)
library(purrr)
library(dplyr)
library(ggplot2)
library(knitr)
library(survival)
library(survminer)

source("get_genotype.R")

trial_path = file.path("..", "Final Project", "NCT00364013")
trial_files = list.files(trial_path, pattern = "*_pds2019.sas7bdat")

dl = map(file.path(trial_path, trial_files), ~ read_sas(.x))
names(dl) = gsub("*_pds2019.sas7bdat", "", trial_files)

# Read in required data
adae = dl$adae #contains adverse events
adsl = dl$adsl #contains subject-level data
biomark = dl$biomark #contains biomarkers

# Select columns relevant to analysis
filtered_biomark <- biomark %>%
  select(c(1:7, 16:17))

# Utilize our get_genotype() function on each subject ID
filtered_biomark$Genotype <- sapply(filtered_biomark$SUBJID, get_genotype)

# Create master table by joining biomarker data with treatment and death metrics
d = left_join(filtered_biomark, 
              adsl[, c("SUBJID", "ATRT", "DTH", "DTHDY")], 
              by = "SUBJID")

# Temp table to get unique adverse events
adverse_events_temp <- adae |>
  group_by(SUBJID, AEPT) |>
  summarize(n = n())

# Count the number of adverse events per subject
adverse_events_per_subject <- adverse_events_temp |>
  group_by(SUBJID) |>
  summarize(adverse_events = n())

# Join adverse events
d <- d |>
  left_join(adverse_events_per_subject, by = "SUBJID")

# Replace NA adverse events with 0
d$adverse_events <- if_else(is.na(d$adverse_events), 0, d$adverse_events)
```


## Visualize dataset

```{r}
d |> group_by(Genotype) |>
  summarize(Count = n()) |>
  ggplot(aes(x = Genotype, y = Count, fill = Genotype)) +
    geom_bar(stat = "identity") +
    labs(title = "KRAS Mutation Status", x = "Genotype", y = "Count") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  
    geom_text(aes(label = Count), vjust = -0.5)

d |>
    filter(Genotype != "Unknown") |> #ignore unknown genotypes
    group_by(ATRT) |>
    summarize(Count = n()) |>
    ggplot(aes(x = ATRT, y = Count, fill = ATRT)) +
    geom_bar(stat = "identity") +
    labs(title = "Treatments", x = "Treatment", y = "Count") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  
    geom_text(aes(label = Count), vjust = -0.5)

d |>
    filter(Genotype != "Unknown") |> #ignore unknown genotypes
    ggplot(aes(x = DTHDY, color = Genotype)) +
      theme_minimal() +
      geom_density() +
      labs(title = "Survival Distribution Over Time", x = "Time to Death (Days)", y = "Density") +
      theme(legend.position = "top")
```


### Data Cleaning and Exploration Summary

1. **Loading and Organizing the Data:**
   - Utilized the `haven` and `purrr` libraries to read SAS datasets into a list.
   - Extracted relevant datasets, including severity code, actual treatment, confirmed responses, and biomarkers.

2. **Biomarker Data Cleaning:**
   - Selected pertinent columns for analysis from the biomarker dataset.
   - Developed a function to determine the genotype based on biomarker information.
   - Added a "Genotype" column to the filtered biomarker data.
   - Provided a summary table of the distribution of genotypes.

3. **Merging Datasets:**
   - Merged relevant datasets based on the 'SUBJID' key, incorporating biomarker information with actual treatment and patient outcomes.

4. **Exploratory Data Analysis (EDA):**
   - Generated summary tables and visualizations to explore the distribution of genotypes, actual treatment, and patient outcomes.
   - Conducted exploratory analysis on ATRT and DTH distributions within each genotype.

5. **Visualization: KRAS Mutation Status:**
   - Created a bar chart to visualize the distribution of KRAS mutation status, providing a clear overview of the dataset.

6. **Kaplan-Meier Survival Analysis:**
   - Filtered out unknown genotypes for survival analysis.
   - Set factors and levels for genotype and actual treatment.
   - Conducted Kaplan-Meier survival analysis to assess the impact of genotype and treatment arm on patient outcomes.
   - Presented Kaplan-Meier survival curves for different scenarios, highlighting potential differences in survival probabilities.

7. **Cox Proportional Hazards Model:**
   - Fitted a Cox Proportional Hazards model to quantify the association between genotype and the hazard of death.
   - Provided a summary of the model's coefficients and significance levels.

# Analysis

## Visualize average survival by genotype

```{r, message=FALSE}
source("plot_survival_days_genotype.R")

plot_survival_days_genotype(d)
```


## Analyze whether number of survival days differed by genotype

```{r}
source("test_survival_days_genotype.R")

test_survival_days_genotype(d)
```

Patients with a mutant genotype generally have 48 to 146 fewer days to live than those with a wild-type (p<0.05).


## Visualize average survival by genotype

```{r, message=FALSE}
source("plot_survival_days_treatment.R")

plot_survival_days_treatment(d)
```


## Analyze whether number of survival days differed by treatment

```{r, message=FALSE}
source("test_survival_days_treatment.R")

test_survival_days_treatment(d)
```

Patients on one or both treatments do not have a different number of survival days (p>0.05).


## Does the combination of Genotype and Treatment Arm have a significant impact on patient survival outcomes?

```{r}
# Filtering out unknown genotypes since these are not informative for this analysis
dcombo <- subset(d, Genotype != "Unknown")

dcombo$Genotype = factor(dcombo$Genotype, ordered = FALSE)
dcombo$Genotype = relevel(dcombo$Genotype, ref = "Wild-type")

dcombo$ATRT = factor(dcombo$ATRT, ordered = FALSE)
dcombo$ATRT = relevel(dcombo$ATRT, ref = "FOLFOX alone")

surv_plot <- ggsurvplot(
  survfit(Surv(DTHDY, DTH) ~ Genotype + ATRT, data = dcombo),
  data = dcombo,
  conf.int = TRUE,
  legend.title = "Genotype & ATRT",
  title = "Kaplan-Meier Survival Curve by Genotype & Treatment Arm",
  xlab = "Time in Days",
  ylab = "Survival Probability",
  pval = TRUE
)

surv_plot$plot + geom_hline(yintercept = 0.5, col = 'red')
```

Here we can see the following:

- There are some statistically significant interactions with p < 0.0001 although it is not specified what those interactions are.

- Subjects with a "Wild-type" genotype generally show higher survival rates over time. 

- Subjects with a "Mutant" genotype generally show lower survival rates over time.

- If a subject has the "Wild-type" genotype, they may have an improved survival rate if they receive 'Panitumumab+FOLFOX' instead of 'FOLFOX alone'

- If a subject has the "Mutant" genotype, they may have an improved survival rate if they receive 'FOLFOX alone' instead of 'Panitumumab+FOLFOX'


## Does the presence of KRAS mutations significantly impact the survival outcomes of metastatic colorectal cancer patients receiving different treatment regimens, specifically Panitumumab in combination with FOLFOX and FOLFOX alone?

The Kaplan-Meier curve assesses whether there are significant differences in survival times among different genotypic groups .

```{r}
ggsurvplot(
  survfit(Surv(DTHDY, DTH) ~ Genotype, data = dcombo),
  data = dcombo,
  conf.int = TRUE,
  legend.title = "Genotype",
  title = "Kaplan-Meier Survival Curve by Genotype",
  xlab = "Time in Days",
  ylab = "Survival Probability",
  risk.table = TRUE
)
```

```{r}
summary(coxph(Surv(dcombo$DTHDY, dcombo$DTH) ~ dcombo$Genotype))
```

1. **Cox Proportional Hazards Model:**
   - The coefficient for `dcombo$GenotypeMutant` is 0.39534, which is positive. This positive coefficient suggests that having the "Mutant" genotype is associated with a higher hazard (risk) of death compared to the "Wild-type" reference group.

2. **Log-Rank Test:**
   - The log-rank test for the "Genotype" variable has a very small p-value (p=8e-07). This suggests that there is a significant difference in survival between different genotypes.

Patients with the "Mutant" genotype have a lower chance of survival compared to those with the "Wild-type" genotype, as indicated by the positive coefficient and the significant log-rank test.


## Are there differences in the occurrence of adverse events between patients receiving Panitumumab in combination with FOLFOX and those receiving FOLFOX alone?

```{r}
source("plot_adverse_events_genotype.R")

plot_adverse_events_genotype(d)
```

```{r}
source("test_adverse_events_genotype.R")

test_adverse_events_genotype(d)
```

```{r}
source("plot_adverse_events_treatment.R")

plot_adverse_events_treatment(d)
```

```{r}
source("test_adverse_events_treatment.R")

test_adverse_events_treatment(d)
```

Wild-type and mutant genotypes do not have different numbers of adverse events during the trial (p>0.05). However, we did find that patients taking Folfox alone had an average of 2 fewer adverse events than patients taking both Folfox combined with Panitumumab (p<0.05).


# Interpretations and Conclusions

 
